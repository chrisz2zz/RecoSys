#### 题目

- 新闻推荐场景下的用户行为预测挑战赛， 该赛题是以新闻APP中的新闻推荐为背景， 目的是**要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章**

#### 数据概况

- 该数据来自某新闻APP平台的用户交互数据，包括30万用户，近300万次点击，共36万多篇不同的新闻文章，同时**每篇新闻文章有对应的embedding向量表示**。
- 从中抽取**20万用户的点击日志数据作为训练集，5万用户的点击日志数据作为测试集A，5万用户的点击日志数据作为测试集B**。具体数据表和参数，可以参考赛题说明。

#### 提交结果的评价方法

- 结合着最后的提交文件来看， 根据sample.submit.csv， 我们最后提交的格式是**针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的**。比如对于user1来说， 我们的提交会是：

  > user1, article1, article2, article3, article4, article5.

  评价指标的公式如下：
  $$
  \text { score }(u s e r)=\sum_{k=1}^{5} \frac{s(u s e r, k)}{k}
  $$

- 假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是**score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。**

#### 赛题详细理解

- 目标： **根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章**。从这个目标上看， 会发现此次和之前遇到的普通的结构化比赛不太一样， 主要有两点：
  - 首先是目标上， **要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题**
  - 数据上， 通过给出的数据我们会发现， **这种数据也不是我们之前遇到的那种特征+标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志**

- 思考方向就是结合我们的目标，**把该预测问题转成一个监督学习的问题(特征+标签)，然后我们才能进行ML，DL等建模预测**。那么我们自然而然的就应该在心里会有这么几个问题：
  - 如何转成一个监督学习问题呢？ 
  - 转成一个什么样的监督学习问题呢？
  -  我们能利用的特征又有哪些呢？ 
  - 又有哪些模型可以尝试呢？ 
  - 此次面对数万级别的文章推荐，我们又有哪些策略呢？

#### 项目总体结构

* 以新闻APP中的新闻推荐， 目的是要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即要预测用户的最后一次点击的新闻文章
* 题目给出的数据：20万用户的点击日志数据作为训练集，用户的点击日志数据包括用户id、点击文章id、点击时间戳、点击环境、点击设备等。36万篇新闻文章的信息数据，包括文章id，文章类型id、文章创建时间戳、文章字数。5万用户的点击日志数据作为测试集，其中特征列和训练数据列名一致。
    * 分析该问题，对用户进行新闻召回之后，需要计算出用户点击该新闻的概率，将待排序的新闻全部计算出预估点击率，在由高到低排序取TopN。该任务属于CTR预估问题，然后看一下数据，这种数据也不是那种特征+标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志。把该预测问题转成一个监督学习的问题(特征+标签)，然后才能进行预测。所以要去构建正负样本，将该问题转为二分类的预测，应该在拿到召回结果的时候，根据是否召回到了用户的历史序列来设置标签。
* 最后看提交结果的评价指标：MRR(Mean Reciprocal Rank)，平均倒数排名
解决方案
* 训练测试集
    * 理想的线下模式：随机抽取5w用户的最后一条点击日志作为线下验证集；训练集中剔除这5w用户的最后一条日志。作为线下训练集；
        * 召回阶段：使用训练集给验证集用户召回，并测试召回结果；打标签0/1
        * 排序阶段：使用召回后的验证集（加上特征工程后的一些特征）训练排序模型，离线验证排序模型指标；保存模型
    * 理想的线上模式：原本的训练集+测试集合并为线上训练集；无验证集；线上测试集为给定的测试集；
        * 召回阶段：使用线上训练集给线上测试集用户做召回
        * 排序阶段：使用线下模式训练的模型给测试集召回结果排序
    * 为了节省训练时间：取验证集为训练集中随机抽取5w用户的最后一条点击日志；训练集为剔除这5w用户的最后一条日志 + 给定的测试集；测试集为给定的测试集；
        * 召回阶段：验证集用来测试召回效果 + 打标签0/1；测试集此时只给其中的用户做召回，不参与指标评估和打标签；
        * 排序阶段：训练集为召回阶段打好标签0/1的验证集（加上特征工程后的一些特征），用来训练排序模型；测试集为含有召回结果的测试集，使用之前的排序模型进行测试
* baseline
    * itemCF：比较了原始的itemCF和改进后的（加入正向反向点击权重、距离衰减）召回指标
        * 原始：   验证集： HitRate5： 0.30     MRR5： 0.17
        * 改进后： 验证集：HitRate5：0.33     MRR5：0.19
    * W2v：比较了Skip-gram 和 CBOW 两种方法召回的指标
        * Skip-gram：验证集：HitRate5：0.15         MRR5：0.08
        * CBOW：    验证集：  HitRate5： 0.13         MRR5：0.07
    * 召回合并： 验证集：HitRate5： 0..34         MRR5：0.21
    * 排序之后： 验证集：HitRate5： 0..43         MRR5：0.26 ； 测试集：MRR5：0.28
* 模型结构：召回 -> 排序
    * 召回：双路召回
        * 改进版的itemCF
            * 训练测试集划分
            * 模型训练
                * 样本工程
                    * 构建方式：相似度矩阵
                * 特征工程
                    * 构建正负样本：召回的文章命中用户最后点击的文章，则label设为1；否则设为0
                * 参数设置
                    * 顺序点击权重：正向点击alpha= 1.0  反向点击alpha=0.7
                    * 距离远近权重：beta = 0.9^(|loc2-loc1|-1)
                    * 总的weight = alpha * beta
            * 模型预测
                * 使用用户历史点击序列的最后两个新闻做召回；除了考虑新闻相似度，还考虑了距离衰减
                * 即相似度评分 = 之前保存的新闻相似度信息wij * (0.7^(loc))，离用户最后一次点击越远，评分权重越低；取100条，评分从高到低排列
            * 评价指标
                * HitRate5：0.33     MRR5：0.19
        * W2v向量召回
            * 训练测试集划分
            * 模型训练
                * 样本工程：哪些样本剔除，哪些样本修正
                * 特征工程
                    * 构建正负样本：召回的文章命中用户最后点击的文章，则label设为1；否则设为0
                * Skip-gram or CBOW
                * 参数设置：滑窗大小等
                    * 词向量维度：256
                    * 窗口大小：6
                    * 负采样大小：5
            * 模型预测：最近邻检索与用户点击过的最后一个新闻向量的最近100个新闻，距离度量公式：余弦距离
            * 评价指标
                * Skip-gram：验证集：HitRate5：0.15         MRR5：0.08
                * CBOW：    验证集：  HitRate5： 0.13         MRR5：0.07
        * 召回合并
            * 合并方式
                * 将得分进行合并
                    * itemCF得分最大值最小值归一化
                    * W2v得分最大值最小值归一化
                    * 得分乘以权重，sum方式合并，itemCF的召回结果由于W2v，所以前者权重大于后者
            * 评价指标
                * 验证集：HitRate5： 0..34         MRR5：0.21
    * 合并后的特征工程
        * 根据新闻的时效性构造强特：
            * 用户历史点击新闻的创建时间 - 用户最后点击新闻时间 差；
            * 用户历史点击新闻的创建时间 - 用户最后点击新闻的创建时间 差；
            * 用户历史点击新闻的创建时间
        * 根据召回保存的新闻相似度信息后遭用户对待预测新闻的评分：
            * 待预测新闻与用户最后一次点击的相似度
            * 待预测新闻与用户历史点击新闻按次序加权求和，越靠近用户最后一次点击 权重越大
        * 根据新闻信息构造特征：
            * 新闻热点：统计待预测新闻在所有点击日志中出现的次数
    * lgbm排序
        * 训练测试集划分
        * baseline
            * LR测试了一下，巨差；AUC: 60%左右
            * lgbm：AUC: 93%左右
        * 模型训练
            * 样本工程：哪些样本剔除，哪些样本修正
            * 特征工程
                * 这里的特征都是int、float类型，都是连续性特征，且新闻得分之前已经归一化；
            * 参数设置
                * 5折交叉验证
                * 叶子数64； 深度10； 学习率0.05； 树的数量(训练的轮次)10000，但早停一般在900附近；
                * 早停系数100；训练指标auc
        * 模型预测
            * 使用5次交叉验证得到的模型，预测加和再平均
        * 评价指标
            * 验证集：HitRate5： 0..43         MRR5：0.26 ； 测试集：MRR5：0.28
            * AUC：93左右
* 整体效果评测
    * 最终提交结果：MRR5 : 0.28