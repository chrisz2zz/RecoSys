### 前言

- 本文对推荐系统中的**协调过滤**和**矩阵分解**知识点进行总结

- 参考自《深度学习推荐系统--王喆》

### 1. 协同过滤简介

- 协同过滤(collaborative filtering, CF)，即**协同大家的反馈、评价、意见一起对海量的信息进行过滤，从中筛选目标用户可能感兴趣的信息的推荐过程。**
- 协同过滤方法分为基于用户的和基于物品的算法:
  - **基于用户的协同过滤算法**：这种算法给用户推荐和他兴趣相似的其他用户喜欢的物品。
  - **基于物品的协同过滤算法**： 这种算法给用户推荐和他之前喜欢的物品相似的物品。

### 2. 基于用户的协调过滤算法（UserCF）

- 基于用户的协同过滤算法的基本思想是：在一个在线个性化推荐系统中，**当一个用户A需要个性化推荐 时，可以先找到和他有相似兴趣的其他用户，然后把那些用户喜欢的、而用户A没有听说过的物品推荐给A**。从上面的描述中可以看到，基于用户的协同过滤算法主要包括两个步骤。 
  - 找到和目标用户兴趣相似的用户集合。
  - 找到这个集合中的用户喜欢的，且目标用户没有听说过的物品推荐给目标用户。

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-1.jpeg)

- 以电商网站为例，用户X访问网站时，推荐系统需要决定是否将电视机推荐该电视机；推荐系统能利用的数据如图(b)所示，用户、商品、评价记录组成的有向图；
- 为了便于计算，将有向图转为**共现矩阵**，矩阵的元素值为用户对商品的赞或踩，如图(c)所示；
- 生成共现矩阵之后，推荐问题即变成了预测矩阵中问号元素；
- 预测的第一步，找到与用户X兴趣相似的n个用户，然后综合相似用户对”电视机“的评价，进行预测；
- 由于B和C用户与X的行向量较为相似，且B和C对电视机的评价是负面的，所以不会对X推荐电视机；

- 关键的两个步骤：**用户相似度计算和最终结果排序**

#### 2.1 用户相似度计算

- 用于共现矩阵中的行向量代表相应用户的用户向量，所以计算用户i和j的相似度就是**计算用户向量i和用户向量j的相似度**，常用方法如下：

  - **余弦相似度：**衡量两向量之间的夹角大小，夹角越小，代表余弦相似度越大，用户越相似。

  $$
  \text { similarity }=\cos (\theta)=\frac{A \cdot B}{\|A\|\|B\|}=\frac{\sum_{i=1}^{n} A_{i} \times B_{i}}{\sqrt{\sum_{i=1}^{n}\left(A_{i}\right)^{2}} \times \sqrt{\sum_{i=1}^{n}\left(B_{i}\right)^{2}}}
  $$

  - **皮尔逊相关系数：**相比余弦相似度，下式使用用户平均分对各独立评分进行修正，减小了用户评分偏置的影响。

  $$
  \operatorname{sim}(i, j)=\frac{\sum_{p \in P}\left(R_{i, p}-\bar{R}_{i}\right)\left(R_{j, p}-\bar{R}_{j}\right)}{\sqrt{\sum_{p \in P}\left(R_{i, p}-\bar{R}_{i}\right)^{2}} \sqrt{\sum_{p \in P}\left(R_{j, p}-\bar{R}_{j}\right)^{2}}} \quad \text { (皮尔逊相关系数) }
  $$

  - P代表所有物品的集合，R(i,p)代表用户i对物品p的评分，减去的数值为用户对所有物品的平均分

  - 如上公式，也可减去物品得到的所用评分的平均分

#### 2.2 最终结果的排序

- 假设目标用户与与其相似的用户的爱好是相同的，可根据相似用户的评价对目标用户的偏好进行预测。常用的方式是**利用用户相似度和相似用户的评价的加权评价获得目标用户的评价预测**，如下所示：

$$
R_{u,p} =\frac{\sum_{s\in S} (w_{u,s} \cdot R_{s,p})}{\sum_{s\in S} w_{u,s}}
$$

- 其中，权重$w_{u,s}$是用户u和用户s的相似度，$R_{s,p}$使用户s对物品p的评分。
- 在获得用户u对不同物品的评价预测之后，最终的推荐列表根据预测得分排序即可得到。

### 3. 基于物品的协同过滤算法（ItemCF）

- 与上相似，ItemCF算法步骤如下：
  - 基于历史数据，构建用户为行坐标，物品为列坐标的m x n的共现矩阵；
  - 计算两两列向量之间的相似性（与用户相似度相同），构建n x n的物品相似度矩阵；
  - 获得用户历史行为数据中的正反馈物品列表；
  - 利用物品相似度矩阵，针对正反馈物品，找出相似的TOP k个物品，组成相似物品集合；
  - 对相似物品集合的物品，利用相似度分值进行排序，生成推荐列表。
- 最后一步中，若一个物品的与多个用户行为历史中的正反馈物品相似，那么该物品的相似度应该是多个相似度的累加：

$$
R_{u,p} =\sum_{h\in H} (w_{p,h} \cdot R_{u,h})
$$

- 其中，H是目标用户的正反馈物品集合，$w_{p,h}$是物品p和物品h的相似度，$R_{u,h}$是用户u对物品h的已有评分

### 4. UserCF和ItemCF的比较

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/2-2.png)

### 5. 协同过滤的问题

- 优点：**直观、解释性强**；缺点：**不具备较强的泛化能力**
- 导致的问题：热门物品容易与大量商品产生相似性，而尾部的物品由于特征向量稀疏，导致很少与其他产生相似性，导致很少被推荐。
- 举例如下图所示：

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-2.png)

- 由物品相似矩阵可知：**A B C的相似度为0，与A B C最相似的是D，因此基于物品的协同过滤推荐会将D推荐给用户。但事实上，D与A B C相似的原因是D为热门商品，系统无法找出A B C的相似性的原因为特征向量稀疏。**协同过滤的问题：**推荐结果的头部效应明显，处理稀疏向量的能力弱。**
- 为解决上述问题，**矩阵分解技术被提出，在共现矩阵的基础上，提出更稠密的隐向量来代表用户和物品，挖掘用户和物品的隐含兴趣和隐含特征，一定程度上弥补了协同过滤模型处理稀疏向量能力不足的问题。**

### 6. 矩阵分解

#### 6.1 算法原理

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-3.png)

- 矩阵分解算法期望为每一个用户和视频生成一个隐向量，距离相近的用户和视频表示兴趣接近。
- **用户和物品的印象里通过分解协同过滤生成的共现矩阵得到，如下图所示：**

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-4.png)

- 基于用户矩阵U和物品矩阵V，用户i对物品i的预估评分为：

$$
r^{评估} = p_u q_i
$$

- $p_u$表示用户u在用户矩阵中的对应行向量，$q_i$是物品i在物品矩阵V中的对应列向量。

#### 6.2 矩阵分解的求解过程

- 原文讲解清晰，如下所示：

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-5.png)

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-6.jpeg)

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-7.jpeg)

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-8.png)

![](https://blog-1258986886.cos.ap-beijing.myqcloud.com/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/3-9.png)

